<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meanwhile Database Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        input, button { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .user-data { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Meanwhile Database Test</h1>
        
        <div class="test-section info">
            <h3>üìã Test Instructions</h3>
            <p>This page will test the database connectivity and authentication flow. Follow these steps:</p>
            <ol>
                <li><strong>First</strong>: Click "Test Database Connection" to verify Supabase is working</li>
                <li><strong>Then</strong>: Try creating a test user with the signup form</li>
                <li><strong>Finally</strong>: Check your Supabase dashboard to see if the user appears in the profiles table</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîå Database Connection Test</h3>
            <button onclick="testConnection()">Test Database Connection</button>
            <div id="connection-result"></div>
        </div>

        <div class="test-section">
            <h3>üë§ Test User Signup</h3>
            <div>
                <input type="text" id="test-username" placeholder="Username" value="testuser123">
                <input type="password" id="test-password" placeholder="Password" value="test1234">
                <input type="text" id="test-firstname" placeholder="First Name" value="Test">
                <input type="text" id="test-lastname" placeholder="Last Name" value="User">
            </div>
            <button onclick="testSignup()">Test Signup</button>
            <div id="signup-result"></div>
        </div>

        <div class="test-section">
            <h3>üîë Test User Login</h3>
            <div>
                <input type="text" id="login-username" placeholder="Username" value="testuser123">
                <input type="password" id="login-password" placeholder="Password" value="test1234">
            </div>
            <button onclick="testLogin()">Test Login</button>
            <div id="login-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä Database Users</h3>
            <button onclick="fetchUsers()">Fetch All Users from Database</button>
            <div id="users-result"></div>
        </div>
    </div>

    <script type="module">
        // Import Supabase client - adjust path if needed
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        // Supabase configuration
        const SUPABASE_URL = 'https://esiqdoxxbdaryblwzoye.supabase.co';
        const SUPABASE_PUBLISHABLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzaXFkb3h4YmRhcnlibHd6b3llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxMzI4NTIsImV4cCI6MjA1MTcwODg1Mn0.Cc8i-8X4l0OUFRhP2iw2VdSQbGMlKHRa_5SvDiTz3Tc';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

        // Helper functions
        const showResult = (elementId, content, isError = false) => {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = isError ? 'error' : 'success';
        };

        const hashPassword = (password) => {
            return btoa(password + 'meanwhile_salt');
        };

        const verifyPassword = (password, hash) => {
            return hashPassword(password) === hash;
        };

        // Test functions
        window.testConnection = async () => {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    showResult('connection-result', `‚ùå Connection failed: ${error.message}`, true);
                } else {
                    showResult('connection-result', '‚úÖ Database connection successful!');
                }
            } catch (err) {
                showResult('connection-result', `‚ùå Unexpected error: ${err.message}`, true);
            }
        };

        window.testSignup = async () => {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            const firstName = document.getElementById('test-firstname').value;
            const lastName = document.getElementById('test-lastname').value;

            if (!username || !password || !firstName || !lastName) {
                showResult('signup-result', '‚ùå Please fill in all fields', true);
                return;
            }

            try {
                // Check if user exists
                const { data: existingUser } = await supabase
                    .from('profiles')
                    .select('id')
                    .eq('username', username.toLowerCase())
                    .single();

                if (existingUser) {
                    showResult('signup-result', '‚ùå Username already exists', true);
                    return;
                }

                // Create new user
                const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const { data: savedUser, error } = await supabase
                    .from('profiles')
                    .insert([{
                        user_id: userId,
                        username: username.toLowerCase(),
                        password_hash: hashPassword(password),
                        first_name: firstName,
                        last_name: lastName
                    }])
                    .select()
                    .single();

                if (error) {
                    showResult('signup-result', `‚ùå Signup failed: ${error.message}`, true);
                } else {
                    showResult('signup-result', `
                        <div>‚úÖ Signup successful!</div>
                        <div class="user-data">
                            <strong>User created:</strong><br>
                            ID: ${savedUser.user_id}<br>
                            Username: ${savedUser.username}<br>
                            Name: ${savedUser.first_name} ${savedUser.last_name}<br>
                            Created: ${new Date(savedUser.created_at).toLocaleString()}
                        </div>
                        <div>üìä Check your Supabase dashboard ‚Üí Table Editor ‚Üí profiles table</div>
                    `);
                }
            } catch (err) {
                showResult('signup-result', `‚ùå Unexpected error: ${err.message}`, true);
            }
        };

        window.testLogin = async () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showResult('login-result', '‚ùå Please enter username and password', true);
                return;
            }

            try {
                const { data: foundUser, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username.toLowerCase())
                    .single();

                if (error || !foundUser) {
                    showResult('login-result', '‚ùå Invalid username or password', true);
                    return;
                }

                if (!foundUser.password_hash || !verifyPassword(password, foundUser.password_hash)) {
                    showResult('login-result', '‚ùå Invalid username or password', true);
                    return;
                }

                showResult('login-result', `
                    <div>‚úÖ Login successful!</div>
                    <div class="user-data">
                        <strong>User authenticated:</strong><br>
                        Username: ${foundUser.username}<br>
                        Name: ${foundUser.first_name} ${foundUser.last_name}<br>
                        Last updated: ${new Date(foundUser.updated_at).toLocaleString()}
                    </div>
                `);
            } catch (err) {
                showResult('login-result', `‚ùå Unexpected error: ${err.message}`, true);
            }
        };

        window.fetchUsers = async () => {
            try {
                const { data: users, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    showResult('users-result', `‚ùå Failed to fetch users: ${error.message}`, true);
                } else if (users.length === 0) {
                    showResult('users-result', 'üì≠ No users found in database yet. Try creating one!');
                } else {
                    const usersList = users.map(user => `
                        <div class="user-data">
                            <strong>${user.username}</strong> (${user.first_name} ${user.last_name})<br>
                            ID: ${user.user_id}<br>
                            Created: ${new Date(user.created_at).toLocaleString()}
                        </div>
                    `).join('');
                    
                    showResult('users-result', `
                        <div>‚úÖ Found ${users.length} user(s) in database:</div>
                        ${usersList}
                    `);
                }
            } catch (err) {
                showResult('users-result', `‚ùå Unexpected error: ${err.message}`, true);
            }
        };

        // Auto-test connection on page load
        setTimeout(window.testConnection, 1000);
    </script>
</body>
</html>
